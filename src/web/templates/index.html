<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Stock Trader Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <nav class="bg-gray-800 border-b border-gray-700 p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold text-blue-400">AI Stock Trader</h1>
            <div class="text-sm text-gray-400">
                <span>Mode:</span>
                <span id="trading-mode" class="ml-2 font-semibold text-white"></span>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-6">
        <!-- Overview Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <div class="text-gray-400 text-sm mb-1">Total Portfolio Value</div>
                <div class="text-3xl font-bold text-white">£<span id="total-value">{{ "{:,.2f}".format(total_value) }}</span></div>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <div class="text-gray-400 text-sm mb-1">Cash Balance</div>
                <div class="text-3xl font-bold text-green-400">£<span id="cash-balance">{{ "{:,.2f}".format(balance) }}</span></div>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <div class="text-gray-400 text-sm mb-1">Market Value</div>
                <div class="text-3xl font-bold text-blue-400">£<span id="market-value">{{ "{:,.2f}".format(total_market_value) }}</span></div>
            </div>
        </div>

        <!-- Active Positions -->
        <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden mb-8">
            <div class="p-6 border-b border-gray-700">
                <h2 class="text-lg font-semibold">Active Positions</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="bg-gray-800/50 text-gray-400 text-xs uppercase tracking-wider">
                            <th class="px-6 py-4 font-semibold">Symbol</th>
                            <th class="px-6 py-4 font-semibold text-right">Quantity</th>
                            <th class="px-6 py-4 font-semibold text-right">Entry Price</th>
                            <th class="px-6 py-4 font-semibold text-right">Current Price</th>
                            <th class="px-6 py-4 font-semibold text-right">Total Value</th>
                            <th class="px-6 py-4 font-semibold text-right">P&L</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700">
                        {% if positions %}
                        {% for p in positions %}
                        <tr class="hover:bg-gray-700/50 transition-colors">
                            <td class="px-6 py-4 font-bold text-blue-400">{{ p.stock.symbol }}</td>
                            <td class="px-6 py-4 text-right">{{ p.quantity }}</td>
                            <td class="px-6 py-4 text-right">£{{ "{:,.2f}".format(p.entry_price) }}</td>
                            <td class="px-6 py-4 text-right">£{{ "{:,.2f}".format(p.current_price) }}</td>
                            <td class="px-6 py-4 text-right font-semibold">£{{ "{:,.2f}".format(p.total_value) }}</td>
                            <td class="px-6 py-4 text-right {% if p.pnl_pct >= 0 %}text-green-400{% else %}text-red-400{% endif %}">{{ "{:+.1f}%".format(p.pnl_pct) }}</td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="6" class="px-6 py-8 text-center text-gray-500">No active positions</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Latest AI Decisions with Validation -->
        <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden mb-8">
            <div class="p-6 border-b border-gray-700">
                <h2 class="text-lg font-semibold">Latest AI Decisions</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="bg-gray-800/50 text-gray-400 text-xs uppercase tracking-wider">
                            <th class="px-6 py-4 font-semibold">Time</th>
                            <th class="px-6 py-4 font-semibold">Symbol</th>
                            <th class="px-6 py-4 font-semibold text-right">Action</th>
                            <th class="px-6 py-4 font-semibold text-right">Confidence</th>
                            <th class="px-6 py-4 font-semibold text-right">Status</th>
                            <th class="px-6 py-4 font-semibold text-right">Validation</th>
                            <th class="px-6 py-4 font-semibold">Reasoning</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700">
                        {% if latest_decisions %}
                        {% for symbol, decision in latest_decisions.items() %}
                        <tr class="hover:bg-gray-700/50 transition-colors">
                            <td class="px-6 py-4 text-sm text-gray-400">{{ decision.timestamp.strftime('%H:%M') }}</td>
                            <td class="px-6 py-4 font-bold text-blue-400">{{ decision.symbol }}</td>
                            <td class="px-6 py-4 text-right">
                                <span class="px-2 py-1 bg-blue-400/10 text-blue-400 text-xs font-bold rounded uppercase">{{ decision.decision }}</span>
                            </td>
                            <td class="px-6 py-4 text-right">{{ "{:.0f}%".format(decision.confidence * 100) }}</td>
                            <td class="px-6 py-4 text-right">
                                <span id="status-{{ symbol }}" class="px-2 py-1 text-xs font-bold rounded"></span>
                            </td>
                            <td class="px-6 py-4 text-right">
                                <span id="validation-{{ symbol }}" class="px-2 py-1 text-xs font-bold rounded"></span>
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-400 max-w-xs">
                                <div class="truncate cursor-help" id="reasoning-text-{{ symbol }}">
                                    {% if decision.remote_validation_comments %}
                                        {{ decision.remote_validation_comments }}
                                    {% elif decision.response and decision.response.reasoning %}
                                        {{ decision.response.reasoning }}
                                    {% elif decision.context and decision.context.rec and decision.context.rec.reasoning %}
                                        {{ decision.context.rec.reasoning }}
                                    {% else %}
                                        No reasoning provided
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="7" class="px-6 py-8 text-center text-gray-500">No decisions recorded yet</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pending Trade Controls -->
        <div id="pending-trades-section" class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden mb-8" style="display: none;">
            <div class="p-6 border-b border-gray-700">
                <h2 class="text-lg font-semibold">Pending Trades</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="bg-gray-800/50 text-gray-400 text-xs uppercase tracking-wider">
                            <th class="px-6 py-4 font-semibold">Symbol</th>
                            <th class="px-6 py-4 font-semibold">Action</th>
                            <th class="px-6 py-4 font-semibold">Confidence</th>
                            <th class="px-6 py-4 font-semibold">Time Remaining</th>
                            <th class="px-6 py-4 font-semibold">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700" id="pending-trades-body">
                        <!-- Pending trades will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        let currentData = null;

        async function fetchData() {
            try {
                const response = await fetch('/api/status');
                currentData = await response.json();
                updateDashboard();
            } catch (error) {
                console.error("Error fetching status:", error);
            }
        }

        function updateDashboard() {
            if (!currentData) return;

            document.getElementById('total-value').textContent = currentData.total_value.toFixed(2);
            document.getElementById('cash-balance').textContent = currentData.balance.toFixed(2);
            document.getElementById('market-value').textContent = currentData.total_market_value.toFixed(2);
            document.getElementById('trading-mode').textContent = currentData.trading_mode === 'paper' ? 'Paper Trading' : 'Live Trading';

            updateLatestDecisions(currentData.latest_decisions);
            updatePendingTrades(currentData.pending_decisions);
        }

        function updateLatestDecisions(decisions) {
            for (const [symbol, decision] of Object.entries(decisions)) {
                const statusCell = document.getElementById(`status-${symbol}`);
                const validationCell = document.getElementById(`validation-${symbol}`);
                const reasoningText = document.getElementById(`reasoning-text-${symbol}`);

                if (!statusCell || !validationCell) continue;

                const badge = getValidationBadge(decision);
                statusCell.textContent = badge.status;
                
                // Simplified Validation text
                let validationText = badge.validation;
                if (decision.remote_validation_decision === 'MODIFY') {
                    validationText = 'Modified';
                } else if (decision.remote_validation_decision === 'REJECT') {
                    validationText = 'Rejected';
                }
                validationCell.textContent = validationText;

                if (reasoningText) {

                    let reason = "No reasoning provided";
                    if (decision.remote_validation_comments) {
                        reason = decision.remote_validation_comments;
                    } else if (decision.response && decision.response.reasoning) {
                        reason = decision.response.reasoning;
                    } else if (decision.context && decision.context.rec && decision.context.rec.reasoning) {
                        reason = decision.context.rec.reasoning;
                    }
                    reasoningText.textContent = reason;
                    reasoningText.title = reason;
                }

                if (badge.status === '⏳') {
                    statusCell.className = 'px-2 py-1 bg-yellow-400/10 text-yellow-400 text-xs font-bold rounded uppercase';
                } else if (badge.status === '✓') {
                    statusCell.className = 'px-2 py-1 bg-green-400/10 text-green-400 text-xs font-bold rounded uppercase';
                } else if (badge.status === '✗') {
                    statusCell.className = 'px-2 py-1 bg-red-400/10 text-red-400 text-xs font-bold rounded uppercase';
                } else {
                    statusCell.className = 'px-2 py-1 text-xs font-bold rounded uppercase';
                }
            }
        }

        function getValidationBadge(decision) {
            if (decision.executed) {
                return { status: '✓', validation: 'Executed' };
            }

            if (decision.remote_validation_decision) {
                if (decision.remote_validation_decision === 'PROCEED') {
                    return { status: '✓', validation: 'Validated' };
                } else if (decision.remote_validation_decision === 'MODIFY') {
                    return { status: '⚠', validation: `Modified: ${decision.remote_validation_comments}` };
                } else if (decision.remote_validation_decision === 'REJECT') {
                    return { status: '✗', validation: `Rejected: ${decision.remote_validation_comments}` };
                } else if (decision.remote_validation_decision === 'TIMEOUT') {
                    return { status: '⏰', validation: 'Auto-rejected: 1h timeout' };
                } else if (decision.remote_validation_decision === 'MANUAL_APPROVE') {
                    return { status: '✓', validation: 'Manually approved' };
                } else if (decision.remote_validation_decision === 'MANUAL_REJECT') {
                    return { status: '✗', validation: 'Manually rejected' };
                }
            }

            if (decision.requires_manual_review && !decision.executed) {
                return { status: '⏳', validation: 'Pending Review' };
            }

            return { status: '⏳', validation: 'Waiting for validation' };
        }

        function getTimeRemaining(decision) {
            if (!decision.validation_timestamp) return 'N/A';

            const now = new Date();
            const validationTime = new Date(decision.validation_timestamp);
            const diff = new Date(decision.manual_review_timeout || (validationTime.getTime() + (60 * 60 * 1000))) - now;

            if (diff <= 0) return 'TIMEOUT';

            const minutes = Math.floor(diff / (60 * 1000));
            const seconds = Math.floor((diff % (60 * 1000)) / 1000);

            if (minutes > 60) return '> 1 hour';
            if (minutes > 0) {
                return `${minutes}m ${seconds}s`;
            }
            return `${seconds}s`;
        }

        function updatePendingTrades(decisions) {
            const tbody = document.getElementById('pending-trades-body');
            const section = document.getElementById('pending-trades-section');
            tbody.innerHTML = '';

            if (decisions.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';

            for (const decision of decisions) {
                const timeRemaining = getTimeRemaining(decision);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 font-bold text-blue-400">${decision.symbol}</td>
                    <td class="px-6 py-4 text-right">
                        <span class="px-2 py-1 bg-blue-400/10 text-blue-400 text-xs font-bold rounded uppercase">${decision.decision}</span>
                    </td>
                    <td class="px-6 py-4 text-right">${(decision.confidence * 100).toFixed(0)}%</td>
                    <td class="px-6 py-4 text-right text-center">
                        <span class="countdown font-mono" id="countdown-${decision.symbol}">${timeRemaining}</span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="approveTrade('${decision.symbol}')" class="px-3 py-1 bg-green-500 hover:bg-green-600 text-white rounded font-semibold">
                            ✓ Approve
                        </button>
                        <button onclick="rejectTrade('${decision.symbol}')" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded font-semibold">
                            ✗ Reject
                        </button>
                    </td>
                </tr>
                `;
                tbody.appendChild(row);
            }
        }

        async function approveTrade(symbol) {
            if (!confirm(`Approve trade for ${symbol}?`)) return;
            await fetch(`/api/trades/${symbol}/approve`, { method: 'POST' });
            await fetchData();
        }

        async function rejectTrade(symbol) {
            const reason = prompt('Rejection reason:');
            if (reason === null) return;
            await fetch(`/api/trades/${symbol}/reject`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reason })
            });
            await fetchData();
        }

        setInterval(fetchData, 5000);
        fetchData();
    </script>
</body>
</html>
